{% extends "base.html" %}
{% load static %}

{% block title %}Hatırlatıcı Uygulaması{% endblock title %}

{% block extra_css %}
<link rel="icon" href="{% static 'images/reminder-icon.png' %}" type="image/x-icon" />
<link href="{% static 'reminder_app/css/dashboard.css' %}" rel="stylesheet" />
{% endblock extra_css %}

{% block body %}
<div class="rmd-blob rmd-blob1"></div>
<div class="rmd-blob rmd-blob2"></div>
<div class="rmd-blob rmd-blob3"></div>

<header class="rmd-app-header">
  <img src="{% static 'images/reminder-icon.png' %}" alt="Reminder Icon" />
  <span class="rmd-app-title">Reminder App</span>
</header>

<div class="container my-5 rmd-container">
  <!-- Top summary -->
  <div class="row g-3 rmd-stats-row">
    <div class="col-12 col-md-4">
      <div class="rmd-stat rmd-stat-primary">
        <div class="rmd-stat-icon"><i class="bi bi-bell"></i></div>
        <div>
          <div class="rmd-stat-label">Yaklaşan Hatırlatıcı</div>
          <div class="rmd-stat-value">
            {% with count=reminders|length %}{{ count|default:"0" }}{% endwith %}
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="rmd-stat rmd-stat-warning">
        <div class="rmd-stat-icon"><i class="bi bi-alarm"></i></div>
        <div>
          <div class="rmd-stat-label">Geciken</div>
          <div class="rmd-stat-value">
            {{ overdue_count|default:"0" }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="rmd-stat rmd-stat-success">
        <div class="rmd-stat-icon"><i class="bi bi-journal-text"></i></div>
        <div>
          <div class="rmd-stat-label">Toplam Not</div>
          <div class="rmd-stat-value">
            {% with ncount=notes|length %}{{ ncount|default:"0" }}{% endwith %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1">
    <!-- Main: Tabs for Notes & Reminders -->
    <div class="col-lg-8">
      <div class="card rmd-card shadow-sm h-100">
        <div class="card-header rmd-card-header rmd-header-primary text-white d-flex align-items-center justify-content-between flex-wrap">
          <ul class="nav nav-tabs rmd-tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-notes" data-bs-toggle="tab" data-bs-target="#pane-notes" type="button" role="tab" aria-controls="pane-notes" aria-selected="true">
                <i class="bi bi-journal-text me-1"></i> Notlarım
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-reminders" data-bs-toggle="tab" data-bs-target="#pane-reminders" type="button" role="tab" aria-controls="pane-reminders" aria-selected="false">
                <i class="bi bi-bell me-1"></i> Hatırlatıcılar
              </button>
            </li>
          </ul>

          <div class="rmd-toolbar d-flex align-items-center gap-2 mt-2 mt-md-0">
            <div class="rmd-search">
              <i class="bi bi-search"></i>
              <input type="text" id="noteSearch" class="form-control rmd-input" placeholder="Notlarda ara...">
            </div>
            <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addNoteModal">
              + Yeni Not
            </button>
          </div>
        </div>

        <div class="card-body p-0">
          <div class="tab-content">
            <!-- Notes Pane -->
            <div class="tab-pane fade show active" id="pane-notes" role="tabpanel" aria-labelledby="tab-notes">
              <div class="p-3 rmd-scrollable" id="notesBody" style="max-height:68vh;">
                {% if notes %}
                  <div class="row row-cols-1 row-cols-md-2 g-3" id="notesGrid">
                    {% for note in notes %}
                      <div class="col rmd-note-col">
                        <div class="card h-100 rmd-note-card">
                          <div class="card-body position-relative">
                            <button class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2 delete-note-btn"
                                    data-url="{% url 'delete_note' note.id %}">
                              <i class="bi bi-x-lg"></i>
                            </button>
                            <h6 class="card-title rmd-note-title">{{ note.title }}</h6>
                            <p class="card-text text-muted rmd-note-text">{{ note.content|truncatewords:28 }}</p>
                            {% if note.reminder_date %}
                              <span class="badge bg-warning text-dark">
                                Hatırlatma: {{ note.reminder_date|date:"d M Y H:i" }}
                              </span>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="rmd-empty">
                    <i class="bi bi-journal-x"></i>
                    <p>Henüz bir notunuz yok.</p>
                  </div>
                {% endif %}
              </div>
            </div>

            <!-- Reminders Pane -->
            <div class="tab-pane fade" id="pane-reminders" role="tabpanel" aria-labelledby="tab-reminders">
              <div class="p-3 rmd-scrollable" style="max-height:68vh;">
                {% if reminders %}
                  <ul class="list-group list-group-flush" id="reminderList">
                    {% for reminder in reminders %}
                      <li class="list-group-item rmd-list-item d-flex justify-content-between align-items-start">
                        <div>
                          <strong class="rmd-item-title">{{ reminder.title }}</strong><br>
                          <small class="text-muted">{{ reminder.date|date:"d M Y H:i" }}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger ms-2 delete-reminder-btn"
                                data-url="{% url 'delete_reminder' reminder.id %}">
                          <i class="bi bi-x-lg"></i>
                        </button>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <div class="rmd-empty">
                    <i class="bi bi-bell-slash"></i>
                    <p>Henüz bir hatırlatıcınız yok.</p>
                  </div>
                {% endif %}
              </div>
            </div>
          </div> <!-- /tab-content -->
        </div>
      </div>
    </div>

    <!-- Right: Sticky Create -->
    <div class="col-lg-4">
      <div class="card rmd-card rmd-sticky">
        <div class="card-header rmd-card-header rmd-header-success text-white d-flex align-items-center justify-content-between">
          <h5 class="mb-0">Yeni Hatırlatıcı</h5>
          <div class="rmd-quickset">
            <button type="button" class="btn btn-sm rmd-chip rmd-q-time" data-q="today-18">Bugün 18:00</button>
            <button type="button" class="btn btn-sm rmd-chip rmd-q-time" data-q="tomorrow-09">Yarın 09:00</button>
          </div>
        </div>

        <div class="card-body">
          <form id="reminderForm" method="POST" action="{% url 'create_reminder' %}">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label rmd-label">Başlık</label>
              <input type="text" class="form-control rmd-input" name="title" required>
            </div>
            <div class="mb-3">
              <label class="form-label rmd-label">Açıklama</label>
              <textarea class="form-control rmd-input" name="description" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label rmd-label">Hatırlatma Tarihi</label>
              <input type="text" id="remindAtInput" class="form-control rmd-input" name="remind_at" required>
            </div>
            <div class="mb-3">
              <label class="form-label rmd-label">Tekrar</label>
              <select class="form-select rmd-input" name="repeat_type" id="repeatTypeSelect">
                <option value="none">Tek Seferlik</option>
                <option value="interval">Belirli Aralıklarla (dk)</option>
                <option value="custom_day">Ayın Belirli Günü</option>
                <option value="custom_weekday">Haftanın Belirli Günü</option>
              </select>
            </div>

            <div class="mb-3 d-none" id="intervalInputWrapper">
              <label class="form-label rmd-label">Kaç dakikada bir tekrar edilsin?</label>
              <input type="number" name="interval_minutes" class="form-control rmd-input" min="1">
            </div>

            <div class="mb-3 d-none" id="customDayWrapper">
              <label class="form-label rmd-label">Ayın kaçıncı günü?</label>
              <input type="number" name="day_of_month" class="form-control rmd-input" min="1" max="31">
            </div>

            <div class="mb-3 d-none" id="customWeekdayWrapper">
              <label class="form-label rmd-label">Haftanın günü</label>
              <select name="day_of_week" class="form-select rmd-input">
                <option value="">Seçiniz</option>
                <option value="0">Pazartesi</option>
                <option value="1">Salı</option>
                <option value="2">Çarşamba</option>
                <option value="3">Perşembe</option>
                <option value="4">Cuma</option>
                <option value="5">Cumartesi</option>
                <option value="6">Pazar</option>
              </select>
            </div>

            <button type="submit" class="btn rmd-btn w-100">Kaydet</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Yeni Not Modal -->
<div class="modal fade" id="addNoteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content rmd-modal">
      <form id="noteForm" method="POST" action="{% url 'create_note' %}">
        {% csrf_token %}
        <div class="modal-header rmd-modal-header">
          <h5 class="modal-title text-light">Yeni Nots</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body rmd-modal-body">
          <div class="mb-3">
            <label class="form-label rmd-label">Başlık</label>
            <input type="text" name="title" class="form-control rmd-input rmd-input-strong" required>
          </div>
          <div class="mb-3">
            <label class="form-label rmd-label">İçerik</label>
            <textarea name="content" class="form-control rmd-input rmd-input-strong" rows="4" required></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label rmd-label">Hatırlatma (opsiyonel)</label>
            <input type="text" id="noteReminderInput" name="reminder_date" class="form-control rmd-input rmd-input-strong" placeholder="Tarih ve saat seçin">
          </div>
        </div>
        <div class="modal-footer rmd-modal-footer">
          <button type="submit" class="btn rmd-btn">Kaydet</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock body %}

{% block js %}
<script src="{% static 'reminder_app/js/dashboard.js' %}"></script>
{% endblock js %}
